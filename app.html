<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to FEN Converter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for dark mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-lg shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-center text-white mb-6">
            Chess Image to FEN Converter
        </h1>

        <!-- Image Uploader -->
        <div class="mb-6">
            <label for="image-upload" class="block mb-2 text-sm font-medium text-gray-300">Upload Chess Position Image</label>
            <input type="file" id="image-upload" accept="image/png, image/jpeg, image/webp"
                   class="block w-full text-sm text-gray-400
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-lg file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-600 file:text-white
                          hover:file:bg-blue-700
                          cursor-pointer"/>
        </div>

        <!-- Image Preview -->
        <div id="image-preview-container" class="mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-200 mb-2">Preview:</h3>
            <img id="image-preview" src="" alt="Chess position preview"
                 class="w-full h-auto max-h-[400px] object-contain rounded-lg bg-gray-700 p-2"/>
        </div>

        <!-- Generate Button -->
        <button id="generate-btn"
                class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg
                       hover:bg-blue-700 focus:outline-none focus:ring-2
                       focus:ring-blue-500 focus:ring-opacity-50
                       transition-colors duration-200 flex items-center justify-center
                       disabled:bg-gray-600 disabled:cursor-not-allowed"
                disabled>
            <span id="btn-text">Generate FEN</span>
            <div id="loading-spinner" class="spinner ml-3 hidden"></div>
        </button>

        <!-- Output Section -->
        <div id="output-section" class="mt-8 hidden">
            <h3 class="text-xl font-semibold text-gray-200 mb-3">Generated FEN:</h3>
            <div class="bg-gray-900 p-4 rounded-lg font-mono text-lg text-green-400 break-words relative">
                <pre id="fen-output" class="whitespace-pre-wrap"></pre>
                <button id="copy-btn" title="Copy to Clipboard"
                        class="absolute top-2 right-2 p-2 bg-gray-700 rounded-lg
                               hover:bg-gray-600 focus:outline-none focus:ring-2
                               focus:ring-blue-500">
                    <!-- SVG for copy icon -->
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 4h8a2 2 0 012 2v8a2 2 0 01-2 2h-8a2 2 0 01-2-2v-8a2 2 0 012-2z"></path>
                    </svg>
                </button>
            </div>
            <p id="copy-message" class="text-sm text-green-500 mt-2 text-right hidden">Copied to clipboard!</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="mt-6 text-center text-red-400 p-3 bg-red-900 bg-opacity-30 rounded-lg hidden">
        </div>
    </div>

    <!-- Hidden textarea for copy functionality -->
    <textarea id="copy-helper" class="absolute -left-full"></textarea>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const generateBtn = document.getElementById('generate-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const outputSection = document.getElementById('output-section');
        const fenOutput = document.getElementById('fen-output');
        const errorMessage = document.getElementById('error-message');
        const copyBtn = document.getElementById('copy-btn');
        const copyMessage = document.getElementById('copy-message');
        const copyHelper = document.getElementById('copy-helper');

        let base64ImageData = null;
        let imageMimeType = null;

        // 1. Handle image upload and preview
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Reset UI
                outputSection.classList.add('hidden');
                errorMessage.classList.add('hidden');
                
                // Read the file as a Data URL (base64)
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    imagePreview.src = dataUrl;
                    imagePreviewContainer.classList.remove('hidden');
                    
                    // Extract mime type and base64 data
                    const parts = dataUrl.split(',');
                    const meta = parts[0].split(';')[0];
                    imageMimeType = meta.split(':')[1];
                    base64ImageData = parts[1];
                    
                    generateBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        // 2. Handle FEN generation button click
        generateBtn.addEventListener('click', () => {
            if (base64ImageData && imageMimeType) {
                callGeminiApi(base64ImageData, imageMimeType);
            } else {
                showError("Please upload an image first.");
            }
        });

        // 3. Show/hide loading state
        function setLoading(isLoading) {
            if (isLoading) {
                btnText.textContent = 'Analyzing...';
                loadingSpinner.classList.remove('hidden');
                generateBtn.disabled = true;
                errorMessage.classList.add('hidden');
                outputSection.classList.add('hidden');
            } else {
                btnText.textContent = 'Generate FEN';
                loadingSpinner.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

        // 4. Show error messages
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // 5. Call the Gemini API
        async function callGeminiApi(base64Data, mimeType) {
            setLoading(true);

            // This is the prompt we send to the AI
            const prompt = `
                You are a chess FEN notation expert.
                Analyze the provided image of a chessboard.
                The board is shown from White's perspective (rank 1 at the bottom, rank 8 at the top).
                Return the complete FEN string for this position.
                If information like active color, castling rights, en passant, and move counts
                are not visible, use the standard defaults: 'w - - 0 1'.
                Your response must be *only* the FEN string and nothing else.
                Example: r1bqkbnr/pppp1ppp/2n5/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 2 3
            `;

            // We leave the API key blank. The environment will provide it.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }
                ],
                // Optional: Configuration to make the response more deterministic
                generationConfig: {
                    temperature: 0.1,
                    topP: 0.1,
                    topK: 1,
                }
            };

            try {
                // We will try the request up to 3 times with exponential backoff
                let response;
                let retries = 3;
                let delay = 1000; // 1 second

                for (let i = 0; i < retries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    }
                    
                    // If response is not ok, wait and retry (e.g., for rate limiting)
                    if (i < retries - 1 && (response.status === 429 || response.status >= 500)) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        // This is a final error (e.g., 400 Bad Request or max retries reached)
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayFen(text.trim());
                } else {
                    let errorMsg = "No content generated. The API returned an empty response.";
                    if (result.promptFeedback) {
                        errorMsg = `Request blocked. Reason: ${result.promptFeedback.blockReason}`;
                    }
                    showError(errorMsg);
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showError("An error occurred while analyzing the image. Please try again.");
            } finally {
                setLoading(false);
            }
        }

        // 6. Display the result
        function displayFen(fenString) {
            // Basic check to see if it looks like a FEN
            if (fenString.split(' ').length < 1 || fenString.split('/').length < 8) {
                 showError(`The AI returned an invalid format. Please try a clearer image. (Got: ${fenString})`);
                 return;
            }

            fenOutput.textContent = fenString;
            outputSection.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        // 7. Handle copy to clipboard
        copyBtn.addEventListener('click', () => {
            const textToCopy = fenOutput.textContent;
            
            // Use the hidden textarea to facilitate copying
            copyHelper.value = textToCopy;
            copyHelper.select();
            copyHelper.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                // Show success message
                copyMessage.classList.remove('hidden');
                setTimeout(() => {
                    copyMessage.classList.add('hidden');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy text. Please copy it manually.');
            }
            
            // Deselect
            window.getSelection().removeAllRanges();
        });

    </script>
</body>
</html>
